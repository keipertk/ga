#
# module: CMakeLists.txt
# author: Bruce Palmer
# description: implements a primative CMake build that can be used to build
#              GA on Windows-based systems. Only MPI-based runtimes are
#              supported.
#
# DISCLAIMER
#
# This material was prepared as an account of work sponsored by an
# agency of the United States Government.  Neither the United States
# Government nor the United States Department of Energy, nor Battelle,
# nor any of their employees, MAKES ANY WARRANTY, EXPRESS OR IMPLIED, OR
# ASSUMES ANY LEGAL LIABILITY OR RESPONSIBILITY FOR THE ACCURACY,
# COMPLETENESS, OR USEFULNESS OF ANY INFORMATION, APPARATUS, PRODUCT,
# SOFTWARE, OR PROCESS DISCLOSED, OR REPRESENTS THAT ITS USE WOULD NOT
# INFRINGE PRIVATELY OWNED RIGHTS.
#
#
# ACKNOWLEDGMENT
#
# This software and its documentation were produced with United States
# Government support under Contract Number DE-AC06-76RLO-1830 awarded by
# the United States Department of Energy.  The United States Government
# retains a paid-up non-exclusive, irrevocable worldwide license to
# reproduce, prepare derivative works, perform publicly and display
# publicly by or for the US Government, including the right to
# distribute to other US Government contractors.
#
# -*- mode: cmake -*-
# -------------------------------------------------------------
# file: CMakeLists.txt
# -------------------------------------------------------------

if (ENABLE_GPU_MEM)
  set(CUDA_INTERFACE_FILES
   cuda_mem_api.cu
  )
endif()
set_source_files_properties(${CUDA_INTERFACE_FILES} PROPERTIES
CUDA_SOURCE_PROPERTY_FORMAT OBJ)

if (ENABLE_FORTRAN)
  set(GA_FORTRAN_INTERFACE_C_FILES
    fapi.c
  )
  set(GA_FORTRAN_INTERFACE_H_FILES
    cnames.h
    # Note: File "global.fh" will be included separately
  )
  set (GA_FORTRAN_INTERFACE_F_FILES
    complex.F
    ga_diag_seq.F
  )
endif()

set(target_libraries
    ma
    elio
    dra
    eaf
    sf)

set(WAPI_FILES
  ga-wapi.h
  ga-wapidefs.h
)

#include_directories(BEFORE ${CMAKE_CURRENT_SOURCE_DIR}
                    #${PROJECT_SOURCE_DIR}/gaf2c
                    #${PROJECT_SOURCE_DIR}/ma
                    #${PROJECT_SOURCE_DIR}/comex/src-armci
include_directories(BEFORE ${CMAKE_CURRENT_BINARY_DIR}
                    ${CMAKE_BINARY_DIR}/gaf2c
                    ${CMAKE_BINARY_DIR}/ma
                    ${CMAKE_BINARY_DIR}/comex/src-armci
                    ${CMAKE_CURRENT_BINARY_DIR}/comex/src-armci
                    ${PROJECT_SOURCE_DIR}/tcgmsg
                    #${PROJECT_SOURCE_DIR}/LinAlg/lapack+blas
                    ${CMAKE_BINARY_DIR}/LinAlg/lapack+blas
)

set(GA_FILES
  base.c
  onesided.c
  collect.c
  ghosts.c
  capi.c
  fapi.c
  datatypes.c
  decomp.c
  DP.c
  elem_alg.c
  ga_diag_seqc.c
  ga_malloc.c
  ga_profile.c
  ga_solve_seq.c
  ga_symmetr.c
  ga_trace.c
  ga_util.c
  global.nalg.c
  global.npatch.c
  global.periodic.c
  global.util.c
  hsort.scat.c
  iterator.c
  matmul.c
  matrix.c
  nbutil.c
  peigstubs.c
  sclstubs.c
  select.c
  sparse.c
  ${GA_FORTRAN_INTERFACE_C_FILES}
  ${GA_FORTRAN_INTERFACE_F_FILES}
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/ga-wapi.h
  COMMAND ${CMAKE_COMMAND} -D INPUT:PATH="${CMAKE_CURRENT_SOURCE_DIR}/ga-papi.h"
     #-D OUTPUT:PATH="${CMAKE_CURRENT_SOURCE_DIR}/ga-wapi.h"
     -D OUTPUT:PATH="${CMAKE_CURRENT_BINARY_DIR}/ga-wapi.h"
     -P ${PROJECT_SOURCE_DIR}/tools/ga_papi_to_wapi.cmake
  DEPENDS ga-papi.h
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/ga-wapidefs.h
  COMMAND ${CMAKE_COMMAND} -D INPUT:PATH="${CMAKE_CURRENT_SOURCE_DIR}/ga-papi.h"
     #-D OUTPUT:PATH="${CMAKE_CURRENT_SOURCE_DIR}/ga-wapidefs.h"
     -D OUTPUT:PATH="${CMAKE_CURRENT_BINARY_DIR}/ga-wapidefs.h"
     -P ${PROJECT_SOURCE_DIR}/tools/ga_papi_to_wapidefs.cmake
  DEPENDS ga-papi.h
)

if (ENABLE_FORTRAN)
message(STATUS "CMAKE_COMMAND:${CMAKE_COMMAND}")
  add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.fh
    COMMAND ${CMAKE_COMMAND} -DINPUT:PATH="${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.h"
       -D OUTPUT:PATH="${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.fh"
       -P ${PROJECT_SOURCE_DIR}/tools/config_fh_from_h.cmake
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.h
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.h
  )
  add_custom_target(
    GenerateGA-mpiFH ALL
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.fh
  )
endif()

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/gacommon.h
                ${CMAKE_CURRENT_BINARY_DIR}/gacommon.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/global.h
                ${CMAKE_CURRENT_BINARY_DIR}/global.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/ga.h
                ${CMAKE_CURRENT_BINARY_DIR}/ga.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/ga_iterator.h
                ${CMAKE_CURRENT_BINARY_DIR}/ga_iterator.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/ga-papi.h
                ${CMAKE_CURRENT_BINARY_DIR}/ga-papi.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/ga-mpi.h
                ${CMAKE_CURRENT_BINARY_DIR}/ga-mpi.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/globalp.h
                ${CMAKE_CURRENT_BINARY_DIR}/globalp.h)

CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/gaconfig.h
                ${CMAKE_CURRENT_BINARY_DIR}/gaconfig.h)

  add_library(ga_src OBJECT
  ${CMAKE_CURRENT_BINARY_DIR}/ga-wapi.h
  ${CMAKE_CURRENT_BINARY_DIR}/ga-wapidefs.h
  ${GA_FILES}
  ${CUDA_INTERFACE_FILES}
  ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
  ${CUDA_INCLUDE_DIRS}
  )

if(ENABLE_FORTRAN)
  ADD_DEPENDENCIES(ga_src GenerateConfigFH)
endif()

# -------------------------------------------------------------
# Global Arrays header installation
# -------------------------------------------------------------
install(FILES
#  abstract_ops.h
#  base.h
#  cnames.h
  gacommon.h
#  gaconfig.h
  ga.h
  ga-mpi.h
  ga-papi.h
#  ga_profile.h
  ga_util.h
#  ga-wapidefs.h
  #ga-wapi.h
#  global.h
#  globalp.h
#  matmul.h
  ${GA_FORTRAN_INTERFACE_H_FILES}
  ${CMAKE_CURRENT_BINARY_DIR}/ga-wapi.h
  ${CMAKE_CURRENT_BINARY_DIR}/global.fh
  DESTINATION include
)
